(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[752],{28314:(e,t,a)=>{"use strict";a.r(t),a.d(t,{default:()=>m});var s=a(73365),l=a(1521),n=a(1702),r=a(64427),i=a(24834),d=a(41633),c=a(34467),o=a(79456),x=a(34936);let m=e=>{var t,a,m,u,h;let{params:p}=e,g=(0,n.useRouter)(),[y,j]=(0,l.useState)(null),[f,v]=(0,l.useState)(!0),[N,b]=(0,l.useState)(!1),[P,w]=(0,l.useState)(!1),[S,C]=(0,l.useState)(!1),[A,k]=(0,l.useState)(""),[M,D]=(0,l.useState)(""),[T,E]=(0,l.useState)(""),[F,O]=(0,l.useState)(""),[V,_]=(0,l.useState)(!1),H=(0,l.use)(p).id,G=async()=>{v(!0);try{let e=await fetch("/api/purchases/".concat(H));if(e.ok){let t=await e.json();j(t)}else console.error("Failed to fetch purchase"),g.push("/dashboard/purchases")}catch(e){console.error("Error fetching purchase:",e),g.push("/dashboard/purchases")}finally{v(!1)}};(0,l.useEffect)(()=>{G()},[H]),(0,l.useEffect)(()=>{if(y){console.log("Purchase data loaded:",{paymentStatus:y.paymentStatus,paymentMode:y.paymentMode,amountPaid:y.amountPaid,total:y.total,allKeys:Object.keys(y)});let e=y.paymentStatus||"Pending";if(k(e),O(y.deliveryStatus||"Pending"),"Paid"===e){let e=y.amountPaid?y.amountPaid.toString():(y.total||0).toString();console.log("Setting Paid status - amountPaid:",e),D(y.paymentMode||"Cash"),E(e)}else if("Partial"===e)if(console.log("Setting Partial status"),D(y.paymentMode||"Cash"),y.amountPaid)E(y.amountPaid.toString());else{let e=Math.floor((y.total||0)/2);E(e.toString()),console.log("No saved amount for Partial status, suggesting:",e)}else console.log("Setting Pending status"),D(y.paymentMode||""),E(y.amountPaid?y.amountPaid.toString():"")}},[y]);let I=async()=>{if("Partial"===A||"Paid"===A){if(!M)return void alert("Please select a payment mode");if(!T||T<=0)return void alert("Please enter a valid amount paid");let e=parseFloat(T);if("Partial"===A&&e>=y.total)return void alert("For partial payment, amount paid must be less than the total amount");if("Paid"===A&&e!==y.total)return void alert("For paid status, amount paid must equal the total amount")}C(!0);try{let t=await fetch("/api/purchases/".concat(H),{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({paymentStatus:A,paymentMode:M,amountPaid:T?parseFloat(T):void 0,deliveryStatus:F})});if(t.ok)await G(),alert("Status updated successfully!");else{var e;let a=await t.json();console.error("Status update error:",a),alert(a.message||(null==(e=a.errors)?void 0:e.join(", "))||"Failed to update status")}}catch(e){console.error("Error updating status:",e),alert("Failed to update status")}finally{C(!1)}},U=async()=>{w(!0);try{let e=await fetch("/api/purchases/".concat(H),{method:"DELETE"});if(e.ok)g.push("/dashboard/purchases");else{let t=await e.json();alert(t.message||"Failed to delete purchase")}}catch(e){console.error("Error deleting purchase:",e),alert("Failed to delete purchase")}finally{w(!1),b(!1)}};if(f)return(0,s.jsx)("div",{className:"flex items-center justify-center min-h-64",children:(0,s.jsx)("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"})});if(!y)return(0,s.jsxs)("div",{className:"text-center py-12",children:[(0,s.jsx)("h2",{className:"text-xl font-semibold text-gray-900",children:"Purchase not found"}),(0,s.jsx)("p",{className:"mt-2 text-gray-600",children:"The purchase you're looking for doesn't exist."}),(0,s.jsx)(d.A,{onClick:()=>g.push("/dashboard/purchases"),className:"mt-4",children:"Back to Purchases"})]});let q=(0,r.Um)(y.items);return(0,s.jsxs)("div",{className:"space-y-6",children:[(0,s.jsxs)("div",{className:"flex flex-col sm:flex-row sm:items-center sm:justify-between",children:[(0,s.jsxs)("div",{children:[(0,s.jsxs)("h1",{className:"text-2xl font-bold text-gray-900",children:["Purchase #",y.purchaseNumber]}),(0,s.jsxs)("p",{className:"mt-1 text-sm text-gray-600",children:["Created on"," ",y.date?new Date(y.date).toLocaleDateString():"Invalid Date"]})]}),(0,s.jsxs)("div",{className:"mt-4 sm:mt-0 flex space-x-2 no-print",children:[(0,s.jsx)(d.A,{variant:"outline",onClick:()=>{_(!0)},className:"pdf-button",children:"Download PDF"}),(0,s.jsx)(d.A,{variant:"outline",onClick:()=>g.push("/dashboard/purchases/edit/".concat(y._id)),className:"edit-button",children:"Edit"}),(0,s.jsx)(d.A,{variant:"outline",onClick:()=>b(!0),className:"delete-button text-red-600 hover:text-red-700",children:"Delete"})]})]}),(0,s.jsxs)("div",{className:"grid grid-cols-1 lg:grid-cols-3 gap-6",children:[(0,s.jsxs)(c.A,{children:[(0,s.jsx)(c.A.Header,{children:(0,s.jsx)(c.A.Title,{children:"Vendor Information"})}),(0,s.jsx)(c.A.Content,{children:(0,s.jsxs)("div",{className:"space-y-2",children:[(0,s.jsxs)("div",{children:[(0,s.jsx)("span",{className:"text-sm font-medium text-gray-500",children:"Vendor Name:"}),(0,s.jsx)("p",{className:"text-gray-900",children:null==(t=y.vendorDetails)?void 0:t.name})]}),(0,s.jsxs)("div",{children:[(0,s.jsx)("span",{className:"text-sm font-medium text-gray-500",children:"Phone:"}),(0,s.jsx)("p",{className:"text-gray-900",children:null==(a=y.vendorDetails)?void 0:a.phone})]}),(0,s.jsxs)("div",{children:[(0,s.jsx)("span",{className:"text-sm font-medium text-gray-500",children:"Address:"}),(0,s.jsx)("p",{className:"text-gray-900",children:null==(m=y.vendorDetails)?void 0:m.address})]}),(0,s.jsxs)("div",{children:[(0,s.jsx)("span",{className:"text-sm font-medium text-gray-500",children:"GST Number:"}),(0,s.jsx)("p",{className:"text-gray-900 font-mono text-sm",children:null==(u=y.vendorDetails)?void 0:u.gstNumber})]})]})})]}),(0,s.jsxs)(c.A,{children:[(0,s.jsx)(c.A.Header,{children:(0,s.jsx)(c.A.Title,{children:"Purchase Summary"})}),(0,s.jsx)(c.A.Content,{children:(0,s.jsxs)("div",{className:"space-y-2",children:[(0,s.jsxs)("div",{className:"flex justify-between",children:[(0,s.jsx)("span",{className:"text-gray-600",children:"Subtotal:"}),(0,s.jsx)("span",{className:"font-medium text-gray-500",children:(0,i.vv)(y.items.reduce((e,t)=>e+t.taxableValue,0))})]}),(0,s.jsxs)("div",{className:"flex justify-between",children:[(0,s.jsx)("span",{className:"text-gray-600",children:"Total GST:"}),(0,s.jsx)("span",{className:"font-medium text-gray-500",children:(0,i.vv)(y.items.reduce((e,t)=>e+t.gst,0))})]}),(0,s.jsxs)("div",{className:"flex justify-between",children:[(0,s.jsx)("span",{className:"text-gray-600",children:"Invoice Value:"}),(0,s.jsx)("span",{className:"font-medium text-gray-500",children:(0,i.vv)(y.items.reduce((e,t)=>e+t.invoiceValue,0))})]}),y.discount>0&&(0,s.jsxs)("div",{className:"flex justify-between",children:[(0,s.jsx)("span",{className:"text-gray-600",children:"Discount:"}),(0,s.jsxs)("span",{className:"font-medium text-gray-500",children:["-",(0,i.vv)(y.discount)]})]}),(0,s.jsx)("div",{className:"border-t pt-2",children:(0,s.jsxs)("div",{className:"flex justify-between text-lg font-bold",children:[(0,s.jsx)("span",{className:"text-gray-600",children:"Final Amount:"}),(0,s.jsx)("span",{className:"font-medium text-red-600",children:(0,i.vv)(y.total)})]})}),"Pending"!==y.paymentStatus&&(0,s.jsxs)("div",{className:"border-t pt-2 mt-2",children:[(0,s.jsx)("div",{className:"text-sm text-gray-600 mb-1",children:"Payment Information:"}),(0,s.jsxs)("div",{className:"flex justify-between text-sm",children:[(0,s.jsx)("span",{className:"text-gray-600",children:"Status:"}),(0,s.jsx)("span",{className:"font-medium ".concat("Paid"===y.paymentStatus?"text-green-600":"text-blue-600"),children:y.paymentStatus})]}),y.paymentMode&&(0,s.jsxs)("div",{className:"flex justify-between text-sm",children:[(0,s.jsx)("span",{className:"text-gray-600",children:"Mode:"}),(0,s.jsx)("span",{className:"font-medium text-gray-900",children:y.paymentMode})]}),y.amountPaid&&(0,s.jsxs)("div",{className:"flex justify-between text-sm",children:[(0,s.jsx)("span",{className:"text-gray-600",children:"Amount Paid:"}),(0,s.jsx)("span",{className:"font-medium text-green-600",children:(0,i.vv)(y.amountPaid)})]}),"Partial"===y.paymentStatus&&y.amountPaid&&(0,s.jsxs)("div",{className:"flex justify-between text-sm",children:[(0,s.jsx)("span",{className:"text-gray-600",children:"Balance:"}),(0,s.jsx)("span",{className:"font-medium text-orange-600",children:(0,i.vv)(y.total-y.amountPaid)})]})]})]})})]}),(0,s.jsxs)(c.A,{children:[(0,s.jsx)(c.A.Header,{children:(0,s.jsx)(c.A.Title,{children:"Status"})}),(0,s.jsx)(c.A.Content,{children:(0,s.jsxs)("div",{className:"space-y-4",children:[(0,s.jsxs)("div",{children:[(0,s.jsx)("label",{className:"text-sm font-medium text-gray-500 block mb-1",children:"Payment Status:"}),(0,s.jsxs)("div",{className:"mb-2",children:[(0,s.jsxs)("span",{className:"px-2 py-1 text-xs font-medium rounded-full ".concat("Paid"===y.paymentStatus?"bg-green-100 text-green-800":"Partial"===y.paymentStatus?"bg-blue-100 text-blue-800":"bg-yellow-100 text-yellow-800"),children:["Current: ",y.paymentStatus]}),A!==y.paymentStatus&&(0,s.jsx)("span",{className:"ml-2 text-xs text-blue-600",children:"(Modified)"})]}),(0,s.jsxs)("select",{value:A,onChange:e=>{let t=e.target.value;console.log("Payment status changed to:",t,"purchase.total:",null==y?void 0:y.total),k(t),"Paid"===t&&y?(console.log("Auto-filling Paid status with amount:",y.total),E(y.total.toString()),D("Cash")):"Partial"===t?(console.log("Auto-filling Partial status"),E(Math.floor((y.total||0)/2).toString()),D("Cash")):"Pending"===t&&(console.log("Clearing fields for Pending status"),E(""),D(""))},className:"w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent text-gray-900 bg-white",children:[(0,s.jsx)("option",{value:"Pending",children:"Pending"}),(0,s.jsx)("option",{value:"Partial",children:"Partial"}),(0,s.jsx)("option",{value:"Paid",children:"Paid"})]})]}),("Partial"===A||"Paid"===A)&&(0,s.jsxs)("div",{children:[(0,s.jsx)("label",{className:"text-sm font-medium text-gray-500 block mb-1",children:"Payment Mode:"}),(0,s.jsxs)("div",{className:"mb-2",children:[y.paymentMode&&(0,s.jsxs)("span",{className:"px-2 py-1 text-xs font-medium rounded-full bg-gray-100 text-gray-800",children:["Current: ",y.paymentMode]}),M!==y.paymentMode&&M&&(0,s.jsx)("span",{className:"ml-2 text-xs text-blue-600",children:"(Modified)"})]}),(0,s.jsxs)("select",{value:M,onChange:e=>D(e.target.value),className:"w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent text-gray-900 bg-white",children:[(0,s.jsx)("option",{value:"",children:"Select Payment Mode"}),(0,s.jsx)("option",{value:"Cash",children:"Cash"}),(0,s.jsx)("option",{value:"Online",children:"Online"})]})]}),("Partial"===A||"Paid"===A)&&(0,s.jsxs)("div",{children:[(0,s.jsx)("label",{className:"text-sm font-medium text-gray-500 block mb-1",children:"Amount Paid (₹):"}),(0,s.jsxs)("div",{className:"mb-2",children:[y.amountPaid&&(0,s.jsxs)("span",{className:"px-2 py-1 text-xs font-medium rounded-full bg-gray-100 text-gray-800",children:["Current: ₹",y.amountPaid]}),T!==(y.amountPaid?y.amountPaid.toString():"")&&T&&(0,s.jsx)("span",{className:"ml-2 text-xs text-blue-600",children:"(Modified)"})]}),(0,s.jsx)("input",{type:"number",value:T,onChange:e=>E(e.target.value),placeholder:"Paid"===A?"₹".concat(y.total):"Enter amount",min:"0",max:"Paid"===A?y.total:y.total-.01,step:"0.01",className:"w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent text-gray-900 bg-white"}),"Partial"===A&&(0,s.jsxs)("p",{className:"text-xs text-gray-500 mt-1",children:["Must be less than ₹",y.total]}),"Paid"===A&&(0,s.jsxs)("p",{className:"text-xs text-gray-500 mt-1",children:["Must equal ₹",y.total]})]}),(0,s.jsxs)("div",{children:[(0,s.jsx)("label",{className:"text-sm font-medium text-gray-500 block mb-1",children:"Delivery Status:"}),(0,s.jsxs)("div",{className:"mb-2",children:[(0,s.jsxs)("span",{className:"px-2 py-1 text-xs font-medium rounded-full ".concat("Delivered"===y.deliveryStatus?"bg-green-100 text-green-800":"Cancelled"===y.deliveryStatus?"bg-red-100 text-red-800":"bg-yellow-100 text-yellow-800"),children:["Current: ",y.deliveryStatus]}),F!==y.deliveryStatus&&(0,s.jsx)("span",{className:"ml-2 text-xs text-blue-600",children:"(Modified)"})]}),(0,s.jsxs)("select",{value:F,onChange:e=>O(e.target.value),className:"w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent text-gray-900 bg-white",children:[(0,s.jsx)("option",{value:"Pending",children:"Pending"}),(0,s.jsx)("option",{value:"Delivered",children:"Delivered"}),(0,s.jsx)("option",{value:"Cancelled",children:"Cancelled"})]})]}),(0,s.jsx)(d.A,{onClick:I,disabled:S||A===y.paymentStatus&&M===y.paymentMode&&T===(y.amountPaid?y.amountPaid.toString():"")&&F===y.deliveryStatus||("Partial"===A||"Paid"===A)&&(!M||!T||T<=0),className:"w-full",children:S?"Updating...":A===y.paymentStatus&&M===y.paymentMode&&T===(y.amountPaid?y.amountPaid.toString():"")&&F===y.deliveryStatus?"No Changes":"Update Status"})]})})]})]}),(0,s.jsxs)(c.A,{children:[(0,s.jsx)(c.A.Header,{children:(0,s.jsx)(c.A.Title,{children:"Purchase Items"})}),(0,s.jsx)(c.A.Content,{children:(0,s.jsx)("div",{className:"overflow-x-auto",children:(0,s.jsxs)("table",{className:"min-w-full divide-y divide-gray-200",children:[(0,s.jsx)("thead",{className:"bg-gray-50",children:(0,s.jsxs)("tr",{children:[(0,s.jsx)("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Product"}),(0,s.jsx)("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"HSN Code"}),(0,s.jsx)("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Quantity"}),(0,s.jsx)("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Unit"}),(0,s.jsx)("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Rate (₹)"}),(0,s.jsx)("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Amount (₹)"}),(0,s.jsxs)("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:["GST (",(null==(h=y.items[0])?void 0:h.gstRate)||5,"%)"]}),(0,s.jsx)("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Total (₹)"})]})}),(0,s.jsx)("tbody",{className:"bg-white divide-y divide-gray-200",children:y.items.map((e,t)=>(0,s.jsxs)("tr",{children:[(0,s.jsx)("td",{className:"px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900",children:e.product}),(0,s.jsx)("td",{className:"px-6 py-4 whitespace-nowrap text-sm text-gray-900",children:e.hsnCode||"-"}),(0,s.jsx)("td",{className:"px-6 py-4 whitespace-nowrap text-sm text-gray-900",children:e.qty}),(0,s.jsx)("td",{className:"px-6 py-4 whitespace-nowrap text-sm text-gray-900",children:e.unit||"-"}),(0,s.jsx)("td",{className:"px-6 py-4 whitespace-nowrap text-sm text-gray-900",children:(0,i.vv)(e.rate)}),(0,s.jsx)("td",{className:"px-6 py-4 whitespace-nowrap text-sm text-gray-900",children:(0,i.vv)(e.taxableValue)}),(0,s.jsx)("td",{className:"px-6 py-4 whitespace-nowrap text-sm text-gray-900",children:(0,i.vv)(e.gst)}),(0,s.jsx)("td",{className:"px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900",children:(0,i.vv)(e.invoiceValue)})]},t))})]})})})]}),Object.keys(q).length>0&&(0,s.jsxs)(c.A,{children:[(0,s.jsx)(c.A.Header,{children:(0,s.jsx)(c.A.Title,{children:"GST Breakdown"})}),(0,s.jsx)(c.A.Content,{children:(0,s.jsx)("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4",children:Object.entries(q).map(e=>{let[t,a]=e;return(0,s.jsxs)("div",{className:"p-3 bg-gray-50 rounded-lg",children:[(0,s.jsxs)("div",{className:"text-sm font-medium text-gray-900",children:[t,"% GST"]}),(0,s.jsxs)("div",{className:"text-xs text-gray-600",children:["Taxable: ",(0,i.vv)(a.taxableAmount)]}),(0,s.jsxs)("div",{className:"text-sm font-medium text-gray-900",children:["Tax: ",(0,i.vv)(a.gstAmount)]})]},t)})})})]}),(0,s.jsx)(o.A,{isOpen:N,onClose:()=>b(!1),title:"Delete Purchase",size:"sm",children:(0,s.jsxs)("div",{className:"space-y-4",children:[(0,s.jsx)("p",{className:"text-gray-600",children:"Are you sure you want to delete this purchase? This action cannot be undone."}),(0,s.jsxs)("div",{className:"flex justify-end space-x-3",children:[(0,s.jsx)(d.A,{variant:"outline",onClick:()=>b(!1),disabled:P,children:"Cancel"}),(0,s.jsx)(d.A,{onClick:U,disabled:P,className:"bg-red-600 hover:bg-red-700",children:P?"Deleting...":"Delete"})]})]})}),V&&(0,s.jsx)(x.A,{purchase:y,onClose:()=>_(!1)})]})}},54282:(e,t,a)=>{Promise.resolve().then(a.bind(a,28314))}},e=>{e.O(0,[96,541,655,358],()=>e(e.s=54282)),_N_E=e.O()}]);